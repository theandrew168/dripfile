{{template "base" .}}

{{define "title"}}Checkout{{end}}

{{define "body"}}
<section>
	<form id="payment-form" data-secret="{{.ClientSecret}}">
		<div id="payment-element">
			<!-- Elements will create form elements here -->
		</div>
		<button id="submit">Submit</button>
		<div id="error-message">
			<!-- Display error message to your customers here -->
		</div>
	</form>
</section>

<script src="https://js.stripe.com/v3/"></script>
<script>
	const stripe = Stripe('{{.StripePublicKey}}');

	const options = {
		clientSecret: '{{.ClientSecret}}',
	}
	const elements = stripe.elements(options);

	const paymentElement = elements.create('payment');
	paymentElement.mount('#payment-element');

	const form = document.getElementById('payment-form');
	form.addEventListener('submit', async (event) => {
		event.preventDefault();

		const {error} = await stripe.confirmSetup({
			//`Elements` instance that was used to create the Payment Element
			elements,
			confirmParams: {
				return_url: '{{.ReturnURL}}',
			}
		});

		if (error) {
			// This point will only be reached if there is an immediate error when
			// confirming the payment. Show error to your customer (for example, payment
			// details incomplete)
			const messageContainer = document.querySelector('#error-message');
			messageContainer.textContent = error.message;
		} else {
			// Your customer will be redirected to your `return_url`. For some payment
			// methods like iDEAL, your customer will be redirected to an intermediate
			// site first to authorize the payment, then redirected to the `return_url`.
		}
	});
</script>
{{end}}
